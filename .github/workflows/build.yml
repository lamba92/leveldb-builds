name: Build LevelDB

on:
  workflow_dispatch:
    inputs:
      version-name:
        description: "Version name"
        required: true
        default: 1.23
      leveldb-ref:
        description: "LevelDB git ref to build"
        required: true
        default: main
      debug:
        description: "Debug mode"
        required: true
        default: true

permissions:
  contents: write

jobs:
  windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: 'google/leveldb'
          ref: ${{ github.event.inputs.leveldb-ref }}
          submodules: true
      - name: Install dependencies with Chocolatey
        run: |
          choco install cmake --no-progress --installargs '"ADD_CMAKE_TO_PATH=System"'
          choco install mingw --no-progress --version=9.4.0 -y
          choco install llvm --no-progress -y

      # Windows ARM64 shared
      - name: Configure shared for Windows ARM64
        run: |
          mkdir build-shared-arm64 && cd build-shared-arm64
          cmake -G "MinGW Makefiles" `
            -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF `
            -DBUILD_SHARED_LIBS=ON `
            -DCMAKE_C_COMPILER=clang `
            -DCMAKE_CXX_COMPILER=clang++ `
            -DCMAKE_SYSTEM_NAME=Windows `
            -DCMAKE_SYSTEM_PROCESSOR=ARM64 `
            -DCMAKE_CXX_FLAGS="--target=aarch64-windows -Dstrdup=_strdup -D_CRT_SECURE_NO_WARNINGS" `
            ..
      - name: Build shared for Windows ARM64
        run: cmake --build build-shared-arm64 --config Release -j8
      - run: Compress-Archive -Path build-shared-arm64\*.dll, build-shared-arm64\*.dll.a -DestinationPath libleveldb-${{ github.event.inputs.version-name }}-windows-shared-arm64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-windows-shared-arm64.zip
          path: libleveldb-${{ github.event.inputs.version-name }}-windows-shared-arm64.zip

      # Windows ARM64 static
      - name: Configure static for Windows ARM64
        run: |
          mkdir build-static-arm64 && cd build-static-arm64
          cmake -G "MinGW Makefiles" `
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF `
          -DBUILD_SHARED_LIBS=OFF `
          -DCMAKE_C_COMPILER=clang `
          -DCMAKE_CXX_COMPILER=clang++ `
          -DCMAKE_SYSTEM_NAME=Windows `
          -DCMAKE_SYSTEM_PROCESSOR=ARM64 `
          -DCMAKE_CXX_FLAGS="--target=aarch64-windows -Dstrdup=_strdup -D_CRT_SECURE_NO_WARNINGS" `
            ..
      - name: Build static for Windows ARM64
        run: cmake --build build-static-arm64 --config Release -j8
      - run: Move-Item -Path ".\build-static-arm64\leveldb.lib" -Destination "libleveldb-${{ github.event.inputs.version-name }}-windows-static-arm64.lib"
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-windows-static-arm64.lib
          path: libleveldb-${{ github.event.inputs.version-name }}-windows-static-arm64.lib

      # Windows x64 shared
      - name: Configure shared for Windows x64
        run: |
          mkdir build-shared-x64 && cd build-shared-x64
          cmake -G "MinGW Makefiles"`
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF `
          -DBUILD_SHARED_LIBS=ON -DCMAKE_CXX_COMPILER=C:\ProgramData\Chocolatey\bin\g++.exe `
          -DCMAKE_C_COMPILER=C:\ProgramData\Chocolatey\bin\gcc.exe ..
      - name: Build shared for Windows x64
        run: cmake --build build-shared-x64 --config Release -j8
      - run: Compress-Archive -Path build-shared-x64\*.dll, build-shared-x64\*.dll.a -DestinationPath libleveldb-${{ github.event.inputs.version-name }}-windows-shared-x64.zip
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-windows-shared-x64.zip
          path: libleveldb-${{ github.event.inputs.version-name }}-windows-shared-x64.zip

      # Windows x64 static
      - name: Configure static for Windows x64
        run: |
          mkdir build-static-x64 && cd build-static-x64
          cmake -G "MinGW Makefiles" `
            -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF `
            -DBUILD_SHARED_LIBS=OFF -DCMAKE_CXX_COMPILER=C:\ProgramData\Chocolatey\bin\g++.exe `
            -DCMAKE_C_COMPILER=C:\ProgramData\Chocolatey\bin\gcc.exe  ..
      - name: Build static for Windows x64
        run: cmake --build build-static-x64 --config Release -j8
      - run: Move-Item -Path ".\build-static-x64\libleveldb.a" -Destination "libleveldb-${{ github.event.inputs.version-name }}-windows-static-x64.a"
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-windows-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-windows-static-x64.a

  linux:
    name: Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: 'google/leveldb'
          ref: ${{ github.event.inputs.leveldb-ref }}
          submodules: true
      - name: Install repositories
        run: sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y && sudo apt-get update
      - name: Install dependencies
        run: |
          sudo apt-get install gcc-9 g++-9 gcc-9-aarch64-linux-gnu g++-9-aarch64-linux-gnu cmake \
          gcc-9-arm-linux-gnueabihf g++-9-arm-linux-gnueabihf gcc-9-aarch64-linux-gnu g++-9-aarch64-linux-gnu -y

      # Linux x64 shared
      - name: Build shared x64
        run: |
          mkdir build-shared-x64 && cd build-shared-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=ON \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_C_COMPILER=gcc-9 -DCMAKE_CXX_COMPILER=g++-9 \
          -DCMAKE_CXX_FLAGS="-static-libgcc -static-libstdc++" .. && \
          cmake --build . -j8
      - run: cp -L build-shared-x64/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-linux-shared-x64.so
      - uses: actions/upload-artifact@v4
        with:
         name: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-x64.so
         path: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-x64.so

      # Linux x64 static
      - name: Build static x64
        run: |
          mkdir build-static-x64 && cd build-static-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_C_COMPILER=gcc-9 -DCMAKE_CXX_COMPILER=g++-9 \
          -DCMAKE_CXX_FLAGS="-static-libgcc -static-libstdc++" .. && \
          $(which cmake) --build . -j8
      - run: cp -L build-static-x64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-linux-static-x64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-linux-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-linux-static-x64.a

      # Linux ARM64 shared
      - name: Build shared arm64
        run: |
          mkdir build-static-arm64 && cd build-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc-9 \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++-9 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_CXX_FLAGS="-static-libgcc -static-libstdc++" \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-static-arm64/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-linux-shared-arm64.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-arm64.so
          path: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-arm64.so

      # Linux ARM64 static
      - name: Build static arm64
        run: |
          mkdir build-shared-arm64 && cd build-shared-arm64 && \
          cmake -DCMAKE_SYSTEM_NAME=Linux -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_SYSTEM_PROCESSOR=aarch64 \
          -DCMAKE_C_COMPILER=aarch64-linux-gnu-gcc-9 \
          -DCMAKE_CXX_COMPILER=aarch64-linux-gnu-g++-9 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_CXX_FLAGS="-static-libgcc -static-libstdc++" \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-shared-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-linux-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-linux-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-linux-static-arm64.a

      - name: Create toolchain file
        run: |
          cat <<EOF > armv7-a.cmake
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_VERSION 1)
          # Specify the cross compiler
          set(CMAKE_C_COMPILER arm-linux-gnueabihf-gcc-9)
          set(CMAKE_CXX_COMPILER arm-linux-gnueabihf-g++-9)
          set(CMAKE_LINKER arm-linux-gnueabihf-ld)
          set(CMAKE_STRIP arm-linux-gnueabihf-strip)
          # Where is the target environment
          set(CMAKE_FIND_ROOT_PATH /usr/arm-linux-gnueabihf)
          # Search for programs in the build host directories
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          # For libraries and headers in the target directories
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_CXX_FLAGS "-static-libgcc -static-libstdc++")
          EOF
      - name: Build shared armv7-a
        run: |
          mkdir build-shared-armv7-a && cd build-shared-armv7-a && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../armv7-a.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON \
          -DCMAKE_CXX_FLAGS="-Wno-psabi" \
          -DCMAKE_C_FLAGS="-Wno-psabi" .. && \
          cmake --build . -j8
      - run: cp -L build-shared-armv7-a/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-linux-shared-armv7-a.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-armv7-a.so
          path: libleveldb-${{ github.event.inputs.version-name }}-linux-shared-armv7-a.so

      # Linux ARMv7-a static
      - name: Build static armv7-a
        run: |
          mkdir build-static-armv7-a && cd build-static-armv7-a && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../armv7-a.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF \
          -DCMAKE_CXX_FLAGS="-Wno-psabi" \
          -DCMAKE_C_FLAGS="-Wno-psabi" .. && \
          cmake --build . -j8
      - run: cp -L build-static-armv7-a/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-linux-static-armv7-a.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-linux-static-armv7-a.a
          path: libleveldb-${{ github.event.inputs.version-name }}-linux-static-armv7-a.a

      # Android ARM64 shared
      - name: Create Android toolchain file
        run: |
          cat <<EOF > android.cmake
          set(CMAKE_SYSTEM_NAME Android)
          set(CMAKE_ANDROID_NDK $($ANDROID_NDK))
          set(CMAKE_SYSTEM_VERSION 35)
          set(CMAKE_ANDROID_STL_TYPE c++_shared)
          EOF

      - name: Build Android ARM64 shared
        run: |
          mkdir build-shared-android-arm64 && cd build-shared-android-arm64 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-shared-android-arm64/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-android-shared-arm64.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-shared-arm64.so
          path: libleveldb-${{ github.event.inputs.version-name }}-android-shared-arm64.so

      # Android ARM64 static
      - name: Build Android ARM64 static
        run: |
          mkdir build-static-android-arm64 && cd build-static-android-arm64 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=arm64-v8a \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-static-android-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-android-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-android-static-arm64.a

      # Android ARMv7 shared
      - name: Build Android ARMv7 shared
        run: |
          mkdir build-shared-android-armv7 && cd build-shared-android-armv7 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=armeabi-v7a \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-shared-android-armv7/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-android-shared-armv7.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-shared-armv7.so
          path: libleveldb-${{ github.event.inputs.version-name }}-android-shared-armv7.so

      # Android ARMv7 static
      - name: Build Android ARMv7 static
        run: |
          mkdir build-static-android-armv7 && cd build-static-android-armv7 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=armeabi-v7a \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-static-android-armv7/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-android-static-armv7.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-static-armv7.a
          path: libleveldb-${{ github.event.inputs.version-name }}-android-static-armv7.a

      # Android x86 shared
      - name: Build Android x86 shared
        run: |
          mkdir build-shared-android-x86 && cd build-shared-android-x86 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=x86 \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-shared-android-x86/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86.so
          path: libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86.so

      # Android x86 static
      - name: Build Android x86 static
        run: |
          mkdir build-static-android-x86 && cd build-static-android-x86 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=x86 \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-static-android-x86/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-android-static-x86.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-static-x86.a
          path: libleveldb-${{ github.event.inputs.version-name }}-android-static-x86.a

      # Android x86_64 shared
      - name: Build Android x86_64 shared
        run: |
          mkdir build-shared-android-x86_64 && cd build-shared-android-x86_64 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=x86_64 \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-shared-android-x86_64/libleveldb.so libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86_64.so
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86_64.so
          path: libleveldb-${{ github.event.inputs.version-name }}-android-shared-x86_64.so

      # Android x86_64 static
      - name: Build Android x86_64 static
        run: |
          mkdir build-static-android-x86_64 && cd build-static-android-x86_64 && \
          cmake -DCMAKE_TOOLCHAIN_FILE=../android.cmake -DCMAKE_BUILD_TYPE=Release \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DCMAKE_ANDROID_ARCH_ABI=x86_64 \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-static-android-x86_64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-android-static-x86_64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-android-static-x86_64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-android-static-x86_64.a

  macos:
    name: Apple
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          repository: 'google/leveldb'
          ref: ${{ github.event.inputs.leveldb-ref }}
          submodules: true

      # macOS arm64 shared
      - name: macOs arm64 shared
        run: |
          mkdir build-macos-shared-arm64 && cd build-macos-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-macos-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-macos-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-macos-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-macos-shared-arm64.dylib

      # macOS arm64 static
      - name: macOs arm64 static
        run: |
          mkdir build-macos-static-arm64 && cd build-macos-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-macos-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-macos-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-macos-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-macos-static-arm64.a

      # macOS x64 shared
      - name: macOs x64 shared
        run: |
          mkdir build-macos-shared-x64 && cd build-macos-shared-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON -DCMAKE_SYSTEM_NAME=Darwin .. && \
          cmake --build . -j8
      - run: cp -L build-macos-shared-x64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-macos-shared-x64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-macos-shared-x64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-macos-shared-x64.dylib

      # macOS x64 static
      - name: macOs x64 static
        run: |
          mkdir build-macos-static-x64 && cd build-macos-static-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF -DCMAKE_SYSTEM_NAME=Darwin .. && \
          cmake --build . -j8
      - run: cp -L build-macos-static-x64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-macos-static-x64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-macos-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-macos-static-x64.a

      # iOS arm64 shared
      - name: iOS arm64 shared
        run: |
          mkdir build-ios-shared-arm64 && cd build-ios-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphoneos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-ios-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-ios-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-shared-arm64.dylib

      # iOS arm64 static
      - name: iOS arm64 static
        run: |
          mkdir build-ios-static-arm64 && cd build-ios-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphoneos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-ios-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-ios-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-static-arm64.a

      # iOS simulator arm64 shared
      - name: iOS simulator arm64 shared
        run: |
          mkdir build-ios-simulator-shared-arm64 && cd build-ios-simulator-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphonesimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-ios-simulator-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-arm64.dylib

      # iOS simulator arm64 static
      - name: iOS simulator arm64 static
        run: |
          mkdir build-ios-simulator-static-arm64 && cd build-ios-simulator-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphonesimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-ios-simulator-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-arm64.a

      # iOS simulator x64 shared
      - name: iOS simulator x64 shared
        run: |
          mkdir build-ios-simulator-shared-x64 && cd build-ios-simulator-shared-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphonesimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-ios-simulator-shared-x64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-x64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-x64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-shared-x64.dylib

      # iOS simulator x64 static
      - name: iOS simulator x64 static
        run: |
          mkdir build-ios-simulator-static-x64 && cd build-ios-simulator-static-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=iOS -DCMAKE_OSX_SYSROOT=iphonesimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-ios-simulator-static-x64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-x64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-ios-simulator-static-x64.a

      # watchOS arm64 shared
      - name: watchOs arm64 shared
        run: |
          mkdir build-watchos-shared-arm64 && cd build-watchos-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-watchos-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-watchos-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-shared-arm64.dylib

      # watchOS arm64 static
      - name: watchOs arm64 static
        run: |
          mkdir build-watchos-static-arm64 && cd build-watchos-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-watchos-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-watchos-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-static-arm64.a

      # watchOS simulator arm64 shared
      - name: watchOs simulator arm64 shared
        run: |
          mkdir build-watchos-simulator-shared-arm64 && cd build-watchos-simulator-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8\
      - run: cp -L build-watchos-simulator-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-arm64.dylib

      # watchOS simulator arm64 static
      - name: watchOs simulator arm64 static
        run: |
          mkdir build-watchos-simulator-static-arm64 && cd build-watchos-simulator-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8\
      - run: cp -L build-watchos-simulator-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-arm64.a

      # watchOS Simulator x64 shared
      - name: watchOS simulator x64 shared
        run: |
          mkdir build-watchos-simulator-shared-x64 && cd build-watchos-simulator-shared-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-watchos-simulator-shared-x64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-x64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-x64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-shared-x64.dylib

      # watchOS Simulator x64 static
      - name: watchOS simulator x64 static
        run: |
          mkdir build-watchos-simulator-static-x64 && cd build-watchos-simulator-static-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=watchOS -DCMAKE_OSX_SYSROOT=watchsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-watchos-simulator-static-x64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-x64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-watchos-simulator-static-x64.a

      # tvOS arm64 shared
      - name: tvOs arm64 shared
        run: |
          mkdir build-tvos-shared-arm64 && cd build-tvos-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-tvos-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-shared-arm64.dylib

      # tvOS arm64 static
      - name: tvOs arm64 static
        run: |
          mkdir build-tvos-static-arm64 && cd build-tvos-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvos \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-tvos-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-static-arm64.a

      # tvOS simulator arm64 shared
      - name: tvOs simulator arm64 shared
        run: |
          mkdir build-tvos-simulator-shared-arm64 && cd build-tvos-simulator-shared-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-simulator-shared-arm64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-arm64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-arm64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-arm64.dylib

      # tvOS simulator arm64 static
      - name: tvOs simulator arm64 static
        run: |
          mkdir build-tvos-simulator-static-arm64 && cd build-tvos-simulator-static-arm64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-simulator-static-arm64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-arm64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-arm64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-arm64.a

      # tvOS simulator x64 shared
      - name: tvOS simulator x64 shared
        run: |
          mkdir build-tvos-simulator-shared-x64 && cd build-tvos-simulator-shared-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvsimulator \
          -DLEVELDB_BUILD_TESTS=OFF -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=ON .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-simulator-shared-x64/libleveldb.dylib libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-x64.dylib
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-x64.dylib
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-shared-x64.dylib

      # tvOS simulator x64 static
      - name: tvOS simulator x64 static
        run: |
          mkdir build-tvos-simulator-static-x64 && cd build-tvos-simulator-static-x64 && \
          cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64 \
          -DCMAKE_SYSTEM_NAME=tvOS -DCMAKE_OSX_SYSROOT=appletvsimulator \
          -DLEVELDB_BUILD_TESTS=off -DLEVELDB_BUILD_BENCHMARKS=OFF \
          -DBUILD_SHARED_LIBS=OFF .. && \
          cmake --build . -j8
      - run: cp -L build-tvos-simulator-static-x64/libleveldb.a libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-x64.a
      - uses: actions/upload-artifact@v4
        with:
          name: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-x64.a
          path: libleveldb-${{ github.event.inputs.version-name }}-tvos-simulator-static-x64.a

  publish-release-with-files:
    name: Create Publication
    needs:
      - windows
      - linux
      - macos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
      - name: Create all in one zip
        run: |
          output_zip="$(pwd)/libleveldb-${{ github.event.inputs.version-name }}-all.zip"
          temp_dir=$(mktemp -d)
          find . -type f | while read -r file; do
              if [[ "$file" == *.zip ]]; then
                  unzip -d "$temp_dir/$(basename "$file" .zip)" "$file"
              else
                  cp "$file" "$temp_dir/"
              fi
          done
          (cd "$temp_dir" && zip -r $output_zip .)
          rm -rf "$temp_dir"
      - uses: softprops/action-gh-release@v2
        if: ${{ github.event.inputs.debug == 'false' }}
        with:
          files: |
            */*
            libleveldb-*.zip
          name: ${{ github.event.inputs.version-name }}
          tag_name: ${{ github.event.inputs.version-name }}
          draft: false
          prerelease: false
          body: ""
