name: Build LevelDB

on: [ push ]

permissions:
  contents: write

jobs:
  windows:
    name: Windows
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Install dependencies with Chocolatey
        run: |
          choco install cmake --no-progress
          choco install mingw --no-progress --version=8.1.0 -y
          choco install llvm --no-progress -y
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew windowsZip
      - uses: actions/upload-artifact@v4
        with:
          name: leveldb-windows
          path: build/archives/leveldb-windows.zip

  linux:
    name: Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - name: Add public keys for Debian
        run: |
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 0E98404D386FA1D9
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 6ED0E7B82643E131
          sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F8D2585B8783D481
      - name: Add Debian repository
        run: |
          echo "deb http://ftp.debian.org/debian buster main" | sudo tee /etc/apt/sources.list.d/debian-buster.list
          sudo apt-get update
      - run: apt-cache search gcc-8-arm-linux-gnueabihf
      - run: apt-cache policy gcc-8-arm-linux-gnueabihf
      - run: |
          sudo apt-get install -t buster binutils-common=2.31.1-16 -y --allow-downgrades
          sudo apt-get install -t buster binutils-arm-linux-gnueabihf -y --allow-downgrades
          sudo apt-get install -t buster gcc-8-arm-linux-gnueabihf g++-8 -arm-linux-gnueabihf -y
      - name: Install cross compilers
        run: sudo apt-get install -y -t buster gcc-8 g++-8 gcc-8-aarch64-linux-gnu g++-8-aarch64-linux-gnu -y
      - name: Install dependencies
        run: sudo apt-get install -y cmake
      - run: chmod +x gradlew
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew linuxZip androidZip
      - uses: actions/upload-artifact@v4
        with:
          name: leveldb-linux
          path: build/archives/leveldb-linux.zip
      - uses: actions/upload-artifact@v4
        with:
          name: leveldb-android
          path: build/archives/leveldb-android.zip

  macos:
    name: macOS
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - run: chmod +x gradlew
      - uses: gradle/actions/setup-gradle@v3
      - run: ./gradlew appleZip
      - uses: actions/upload-artifact@v4
        with:
          name: leveldb-apple
          path: build/archives/leveldb-apple.zip

  publish-release-with-files:
    name: Create Publication
    needs:
      - windows
      - linux
      - macos
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
      - uses: actions/download-artifact@v4
      - run: chmod +x gradlew
      - uses: gradle/gradle-build-action@v3
      - run: ./gradlew mergeZips
      - uses: actions/upload-artifact@v4
        with:
          name: leveldb
          path: build/archives/leveldb.zip
      - name: Set current date as env variable
        id: set_date
        run: echo "NOW=$(date +'%Y%m%dT%H%M%S')Z" >> $GITHUB_OUTPUT
      - run: tree
      - uses: softprops/action-gh-release@v2
        with:
          files: build/archives/leveldb.zip
          name: v${{ steps.set_date.outputs.NOW }}-SNAPSHOT
          tag_name: ${{ steps.set_date.outputs.NOW }}
          draft: false
          prerelease: false
